// feed
var feed_controller;
var feed_id = null;
var count;
var stop = false;
var pause = true;
var obj = {trans: {}};

// text
var delete_message_text = 'Are you sure you want to delete it?';
var unsaved_progress_text = 'There is unsaved content! Continue?';

// general icon
var thumbs_up = "<i class='thumbsUp'></i>";

// initialize

function configure_feed(attribute, checkbox) {
	ajax_request('/user_news_feed/set_attribute?attribute=' + attribute + '&value=' + (checkbox.checked ? 'true' : 'false'));
}

function init_feed_post(the_controller, the_id, sticky, supports_bronze_features, targeted, $biz, disable_family, message) {
	feed_controller = the_controller;
	feed_id = the_id;
    obj.sticky = sticky;
    obj.bronze = supports_bronze_features;
    obj.targeted = targeted;
    obj.biz = $biz;
    obj.family = !disable_family;
    obj.message = message;
}

function init_feed(the_controller, the_id, the_count) {
	feed_controller = the_controller;
	feed_id = the_id;
	count = the_count;
}

function add_feed_id() {
	return (feed_id == null ? '' : '/' + feed_id);
}

// post

function hide_post() {
	clear_value('post_message');
	var sticky_box = $('#sticky_post');

	if (sticky_box) {
		sticky_box.attr('checked', false);
	}

	hide_element('post_form');
	show_element('news_options');

  $('#post_filecontainer').html('');
}

function submit_post() {
	var message = get_value('post_message');
	var sticky = ((sticky_box = $('#sticky_post')) && sticky_box.attr('checked'));
	var selector_name = 'attachments';

	if ((message != null) && (strip2(message).length > 0)) {
		// send the file attachments
		var attach_segment = '';
		var $attach = $('#post_filecontainer input[name^="' + selector_name + '"]');

		if ($attach.length > 0) {
			for (var i = 0; i < $attach.length; i++) {
				if ($attach.eq(i).parent().hasClass("done")) {
					attach_segment += '&' + selector_name + '[]=' + encodeURIComponent($attach.eq(i).val());
				}
			}
		}
		
		$('#post_filecontainer').html('');
    
		ajax_update('news1', '/' + feed_controller + '/post' + add_feed_id()
				+ '?sticky=' + (sticky ? 'true' : 'false') 
				+ '&message=' + encodeURIComponent(message) + attach_segment);
		hide_post();
	}
}

function delete_post(number, posting_id) {
  $.confirm({
    content : delete_message_text,
    confirm : function() {
      ajax_request('/' + feed_controller + '/delete_posting' + add_feed_id() + '?posting=' + posting_id);
      $.when($('#row' + number).fadeOut()).done(function() {
        update_min_height();
      });
    }
  });
}

function highlight_post() {
	do_image_popups();
	var newest_id = 0, id_list = {};
	
	$("#news1 .comment").each(function(){
		var post_id = parseInt($(this).attr('data-order'));
		var id = $(this).attr('id').replace('row', '');
		id_list[post_id] = id;
		
		if (newest_id < post_id) {
			newest_id = post_id; 
		}
	});
	
	highlight_element("row" + id_list[newest_id], false);
}

// announcements

function delete_announcement(number, url) {
  $.confirm({
    content : delete_message_text,
    confirm : function() {
      ajax_update('announcements_section', url);
      $.when($('#row' + number).fadeOut()).done(function() {
        update_min_height();
      });
    }
  });
}

function hide_announcement() {
	clear_value('announcement_message');
	var sticky_box = $('#sticky_announcement');

	if (sticky_box) {
		sticky_box.attr('checked', false);
	}

	hide_element('announcement_form');
	show_element('news_options');
	
	$('#announcement_filecontainer').html('');
}

function submit_announcement(messages) {
	var message = get_value('announcement_message');

	var sticky_box = $('#sticky_announcement');
	var sticky = ((sticky_box != null) && sticky_box.is(":checked"));

	var to_students = $('#to_students');
	var students = ((to_students != null) && to_students.is(":checked"));

	var to_teachers = $('#to_teachers');
	var teachers = ((to_teachers != null) && to_teachers.is(":checked"));

	var to_parents = $('#to_parents');
	var parents = ((to_parents = $('#to_parents')) && to_parents.is(":checked"));

	var to_managers = $('#to_managers');
	var managers = ((to_managers != null) && to_managers.is(":checked"));

  var selector_name = 'attachments';

	// send the file attachments
	var attach_segment = '';
	
	var attach = $('#announcement_filecontainer input[name^="' + selector_name + '"]');

	if (attach.size() > 0) {
		for (var i = 0; i < attach.size(); i++) {
			if (attach.eq(i).parent().hasClass("done")) {
				attach_segment += '&' + selector_name + '[]=' + encodeURIComponent(attach.eq(i).val());
			}
		}
	}
  
  $('#announcement_filecontainer').html('');
  
	if ((message != null) && (strip2(message).length > 0)) {
		ajax_update('news1', '/' + feed_controller + '/announcement' + add_feed_id()
				+ '?sticky=' + (sticky ? 'true' : 'false') 
				+ '&students=' + (students ? 'true' : 'false') 
				+ '&teachers=' + (teachers ? 'true' : 'false') 
				+ '&parents=' + (parents ? 'true' : 'false') 
				+ '&managers=' + (managers ? 'true' : 'false') 
				+ '&messages=' + messages
				+ '&message=' + encodeURIComponent(message) + attach_segment);
		hide_announcement();
	}
}

function refresh_announcements() {
	highlight_post();
	ajax_update('announcements_section', '/' + feed_controller + '/refresh_announcements' + add_feed_id());
}

// system notice

function show_system_notice() {
	hide_element('news_options');
	show_element('system_notice_form');
	focus_element('system_notice_message');
}

function hide_system_notice() {
	clear_value('system_notice_message');
	hide_element('system_notice_form');
	show_element('news_options');
}

function submit_system_notice() {
	var message = get_value('system_notice_message');
	var students = ((to_students = $('#to_students_system')) && to_students.attr('checked'));
	var teachers = ((to_teachers = $('#to_teachers_system')) && to_teachers.attr('checked'));
	var parents = ((to_parents = $('#to_parents_system')) && to_parents.attr('checked'));
	var managers = ((to_managers = $('#to_managers_system')) && to_managers.attr('checked'));
	var administrators = ((to_administrators = $('#to_administrators_system')) && to_administrators.attr('checked'));

	if ((message != null) && (strip2(message).length > 0)) {
		ajax_update('news1', '/' + feed_controller + '/system_notice' + add_feed_id()
				+ '?students=' + (students ? 'true' : 'false')
				+ '&teachers=' + (teachers ? 'true' : 'false') 
				+ '&parents=' + (parents ? 'true' : 'false') 
				+ '&managers=' + (managers ? 'true' : 'false') 
				+ '&administrators=' + (administrators ? 'true' : 'false') 
				+ '&message=' + encodeURIComponent(message));
		hide_system_notice();
	}
}

// miscellaneous

function strip2(string) {
	return string.replace(/^\s*/, '').replace(/\s*$/, '');
}

// notifications

function delete_notification(number, url) {
  $.confirm({
    content : delete_message_text,
    confirm : function() {
      ajax_request(url);
      $.when($('#row' + number).fadeOut()).done(function() {
        update_min_height();
      });
    }
  });
}

// likes

function like(likes, number, posting_id) {
	ajax_request('/' + feed_controller + '/like' + add_feed_id() + '?posting=' + posting_id);
	$('#like_' + number).hide();
	$('#unlike_' + number).show();
	var likes_span = $('#likes_' + number);

	if (likes_span.data('likes') == null) {
		likes_span.data('likes', likes);
	} else {
		likes = likes_span.data('likes');
	}

	likes += 1;

    // TRANSLATE
	if (likes == 1) {
		likes_span.html("<br/>" + thumbs_up + " You like this.");
	} else if (likes == 2) {
		likes_span.html("<br/>" + thumbs_up + " You and <a href='javascript:likes(" + posting_id + ")'> 1 other person" + "</a> likes this.");
	} else {
		likes_span.html("<br/>" + thumbs_up + " You and <a href='javascript:likes(" + posting_id + ")'> " + (likes - 1) + " other people</a> like this.");		
	}

	likes_span.show();
	likes_span.effect("highlight", {}, 3000);
	likes_span.data('likes', likes);
}

function unlike(likes, number, posting_id) {
	ajax_request('/' + feed_controller + '/unlike' + add_feed_id() + '?posting=' + posting_id);
	$('#unlike_' + number).hide();
	$('#like_' + number).show();
	var likes_span = $('#likes_' + number);

	if (likes_span.data('likes') == null) {
		likes_span.data('likes', likes);
	} else {
		likes = likes_span.data('likes');
	}

	likes -= 1;

	// TRANSLATE
	if (likes == 0) {
		likes_span.hide();
	} else {
		if (likes == 1) {
			likes_span.html("<br/>" + thumbs_up + "<a href='javascript:likes(" + posting_id + ")'> 1 person </a> likes this.");			
		} else {
			likes_span.html("<br/>" + thumbs_up + "<a href='javascript:likes(" + posting_id + ")'>" + likes + " people </a> like this.");			
		}		

		likes_span.show();
		likes_span.effect("highlight", {}, 3000);
	}

	likes_span.data('likes', likes);
}

function likes(posting_id) {
	var url = '/' + feed_controller + '/likes' + add_feed_id() + '?posting=' + posting_id;

	$.facebox({
		'ajax' : url
	});
}

// image pop-ups

function do_image_popups() {
	$('a[rel*=facebox]').each(function() {
		if (!$(this).hasClass("_processed")) {
			$(this).addClass("_processed").facebox();
		}
	});
}

on_ready(do_image_popups);

function getRealWidth($el) {
	return $el.width() + parseInt($el.css("padding-left"), 10) + parseInt($el.css("padding-right"), 10);
}

function getRealHeight($el) {
	return $el.height() + parseInt($el.css("padding-top"), 10) + parseInt($el.css("padding-bottom"), 10);
}

// comments

function comment_form_html(id) {
	// translate Comment, Cancel
	
	var html = '<div id="commentForm' + id + '">\
					<form class="noBorderForm">\
						<textarea class="commentMessage" id="comment' + id + '" name="comment' + id + '"></textarea></form>\
						<div id="commentControll' + id + '" class="optionsRibbon">\
							<ul>\
								<li><a href="javascript:void(0);" id="submitCom"><i class="add"></i>' + comment_text + '</a></li>\
								<li><a href="javascript:void(0);" id="cancelCom"><i class="xCross"></i>' + cancel_text + '</a></li>\
							</ul>\
						</div>\
					</div>';
	return html;
}

function append_comment_form_html(id) {
	if ($("#commentForm" + id).length === 0) {
		$("#comments" + id).append(comment_form_html(id));
		$("#commentForm" + id).hide().fadeIn();
	}
}

function close_comment_form(id) {
	$("#commentForm" + id).fadeOut(100, function() {
		$(this).remove();
	});
}

function submit_comment_form(p) {
	var comment = get_value('comment' + p.id);
	var url;
	
	if ((comment != null) && (strip2(comment).length > 0)) {
		url = '/' + feed_controller + '/comment' + add_feed_id() + '?posting=' + p.posting_id + "&parent_deletable=" + p.parent_delete + "&comment=" + encodeURIComponent(comment);
		
		if (p.reply) {
			url = url + "&reply=true";
		}
		
		ajax_update('comments' + p.id, url);
	}
	
	close_comment_form(p.id);
}

function adding_action_events(p) {
	$("#commentControll" + p.id + " a").on("click", function() {
		var objClass = $(this).attr('id');
		
		switch (objClass) {
			case 'cancelCom':
				close_comment_form(p.id);
				break;
				
			case 'submitCom':
				submit_comment_form(p);
				break;
				
			default:
				break;
		}
	});
}

function show_comment_form(id, posting_id, parent_delete, reply) {
	p = {
		id : id,
		posting_id : posting_id,
		parent_delete : parent_delete
	};
	
	if (reply) {
		p.reply = reply;
	}
	
	append_comment_form_html(p.id);
	adding_action_events(p);
	focus_element('comment' + p.id);
}

function delete_comment(id) {
  $.confirm({
    content : delete_message_text,
    confirm : function() {
      ajax_request('/' + feed_controller + '/delete_posting' + add_feed_id() + '?posting=' + id);

      $('#comment_row' + id).fadeOut(300, function() {
        $(this).remove();
        update_min_height();
      });
    }
  });
}

function highlight_comment(id) {
	highlight_element('comment_' + id, true);
}

// Generate main news feed forms
function post_generate_controlls(p) {
	var contr = '';
  var query_string = encodeURIComponent(JSON.stringify({"multi" : "true", "wrapper" : p.type + "_filecontainer"}));

  contr += '<li' + ((window.IE === 8) ? ' style="float:left;border:1px solid #c8c8c8;"' : '') + '><a style="position:relative;z-index:0;" href="/uploader?data_json=' +  query_string + '" onclick="$.facebox({\'ajax\':this.href});return false;" class="pickfiles" id="' + p.type + '_pickefiles"><i class="folderUp"></i>' + file_text + '</a></li>';
	
	contr += '<li><a href="javascript:hide_' + p.type + '();" ' + ( p.type === 'post' ? 'class="cancelfeed"' : '' ) + '><i class="xCross"></i>' + cancel_text + '</a></li>';

	if ((p.type === 'announcement') && p.plus_message) {
		contr += '<li><a href="javascript:submit_announcement(true);"><i class="email"></i>' + send_message_text + '</a></li>';
	}
	
	contr += '<li><a href="javascript:submit_' + p.type + '( ' + (p.type === 'announcement' ? 'false' : '')  + ' );" ' + (p.type === 'post' ? 'class="postfeed"' : '') + '>'
	      + '<i class="add"></i>' + send_text + '</a></li>';

	return contr;
}

function post_form_controlls(p) {
	return '<div class="optionsRibbon withBorder"><ul>' + post_generate_controlls(p) + '</ul></div>';
}

function create_announcement_checkbox(id, label, value, checked, disabled) {
	return '<input type="checkbox" ' + (checked ? 'checked="checked"' : '') + (disabled ? ' disabled="disabled"' : '') + ' id="' + id + '" name="' + id + '" ' + ( value ? 'value="'+ value +'"' : '' ) + '>'
			+ '<label for="' + id + '">' + label + '</label>';
}

function generate_targeted_options(p) {
	var html = send_to_text + p.spacer;
	html += create_announcement_checkbox('to_students', students_text, true, true);
	html += create_announcement_checkbox('to_teachers', teachers_text, true, true);
	
	if (p.op.biz) {
		html += create_announcement_checkbox('to_managers', managers_text, true, true);
	} else if (p.op.family) {
		html += create_announcement_checkbox('to_parents', parents_text, true, true);
	}
	
  html += create_announcement_checkbox('to_administrators', administrators_text, true, true, true);
	return html;
}

function generate_post_options(p) {
	return '<p>' + sticky_question_text + p.spacer + '<input id="sticky_' + p.type + '" name="sticky_' + p.type + '" value="1" type="checkbox"> <label for="sticky_' + p.type + '"></label></p>';
}

function generate_announcement_options(p) {
	var html = '<p>';
	
	if (p.op.bronze) {
		html += sticky_question_text + p.spacer + '<input id="sticky_' + p.type + '" name="sticky_' + p.type + '" value="1" type="checkbox"> <label for="sticky_' + p.type + '"></label>';
	}
	
	if (p.op.targeted) {
		html += generate_targeted_options(p);
	}
	
	html += '</p>';
	return html;
}

function post_form_html(p) {
	var html = '<div id="' + p.type + '_form" class="post_form_flag" style="position:relative;">' 
				+ '<form action="/' + p.controller + '/' + p.type + '/' + p.id + '" class="noBorderForm" method="post">'
				+ '<textarea class="postMessage" id="' + p.type + '_message" name="' + p.type + '_message"></textarea>';
	
	html += '<div id="' + p.type + '_filecontainer" class="filecontainer uploader-list"></div>';
				
	if ((p.type === 'post') && p.op.sticky && p.op.bronze) {
		html += generate_post_options(p);
	} else if ((p.type === 'announcement') && (p.op.targeted || p.op.bronze)) {
		html += generate_announcement_options(p);
	}
	
	html += '</form>' + post_form_controlls(p) + '</div>';
	return html;
}

function append_post_form_html(p) {
	if ($('#' + p.type + '_form').length == 0) {
		$(p.obj).parents('#' + p.wrapper).after(post_form_html(p));
	} else {
		show_element(p.type + '_form');
	}
	
	focus_element(p.type + '_message');
}

function generate_form(id, type, controller, object, max_upload, plus_message) {
	var p = {
			id: id,
			type: type,
			controller: controller,
			obj: object,
			wrapper: 'news_options',
			up_limit: max_upload,
			plus_message: (plus_message || false),
			op: (obj || null),
			spacer: '&nbsp;&nbsp;&nbsp;'
	};
	
	hide_element(p.wrapper);
	append_post_form_html(p);
}

//showing more news - with the infinite scroll

function scroll_for_more_news() {
	$('#more_news' + count).show();
	$('#more_news' + count + ' a.view_more').on('click', function(){ more_news(); });
	
	$(window).scroll(function() {
		if (pause) {
			if ($(window).scrollTop() >= $(document).height() - $(window).height() - 50) {
				pause = false;
				more_news();
			}
		}
	});
}

function more_news(number, start, child) {
	var more = $('#more_news' + count + ' a.view_more'), 
		number = more.attr('data-number'), 
		start = more.attr('data-date'), 
		child = more.attr('data-child'),
		url = '/' + feed_controller + '/more_news' + add_feed_id() + '?count=' + count + '&number=' + number + '&start=' + start + '&child=' + child;
		
	if (!stop) {
		$.ajax({
			type: "POST",
			url: url,
			beforeSend: function(){
				more.hide().parent().append('<img src="/images/loading-animation-' + (is_grey_page_mode() ? 'grey' : 'white') + '-retina.gif" width="100" />');
			},
			success: function(data) {
				$("#news" + count).after('<div id="news' + (count + 1) + '">' + data + '</div>');
				pause = false;
				
				do_image_popups();
				enable_user_popups();
				remove_element('more_news' + ( count - 1));
				$('#more_news' + count).show();
				pause = true;
				
				if ($("#news" + count + ' .comments .comment').length === 0) { 
					stop = true; 
					pause = false;
				}
			}
		});
	}
}

// action for the remove sticky

function remove_sticky(number, url) {
	ajax_request(url, {asynchronous: false});
	location.reload();
}

// edit post init

function edit_post_init(type, id, number, comment) {
	if (!edit_post_cancel(type, id, number, comment)) {
		return false;
	}
	
	if (check_for_long(type, number, comment)) {
		dispay_the_correct_blocks(type, number, comment);
		hide_the_more_arrow(type, number, comment);
		
		var multiple_truncate = true;
	}
	
	var post = $('#' + type + number);
	var content_wrapper = post.find('.post-content').first();
	var content = content_wrapper.html().trim().replace(/(<br>|<br\/>|<br \/>)/g, '\n').replace(/^\s+|\s+$/g, '');
	
	var posting_content;
	
	$.ajax({
		type: 'POST',
		url: '/' + feed_controller + '/get_post_content' + add_feed_id() + '?posting=' + id,
		dataType: 'json',
		async: false,
		success: function(data) {
			posting_content = data.message;
		}
	});
	
	if (content_wrapper.find('textarea').length == 0) {
		content_wrapper.hide();
		content_wrapper.empty();
		content_wrapper.append('<div class="original-content" data-id="' + id + '" data-type="' + type + '" data-number="' + number + '" style="display:none">' + posting_content + '</div>');
		content_wrapper.append('<div class="original-html-content" style="display:none">' + content + '</div>');
		content_wrapper.append('<textarea class="postContent" id="post_content" name="post_message">' + posting_content + '</textarea>');
		content_wrapper.append('<div class="optionsRibbon withBorder"><ul><li><a href="javascript:edit_post_save(' + id + ', ' + comment + ', ' + multiple_truncate + ');" class="postfeed"><i class="tick"></i>' + save_text + '</a></li><li><a href="javascript:void(0);" onclick="edit_post_cancel(\''+type+'\', '+id+', '+number+', ' + comment + ', ' + multiple_truncate + ')" class="cancelfeed"><i class="xCross"></i>' + cancel_text + '</a></li></ul></div>');
		content_wrapper.fadeIn();
	}
}

function edit_post_save(id, comment, multiple_truncate) {
	var main = $('#centreColumn');
	var textarea = main.find('.comment .post-content textarea');
	var parent = $(textarea[0]).parent();
	var text = textarea.val();
	var type = parent.find('.original-content').data('type');
	var number = parent.find('.original-content').data('number');
	
	$.ajax({
		type: 'POST',
		url: '/' + feed_controller + '/edit_post' + add_feed_id() + '?posting=' + id,
		data: {message: text},
		dataType: 'json',
		async: false,
		success: function(data) {
			edit_post_update(parent, id, comment, multiple_truncate);
			show_the_more_arrow(type, number, comment);
		}
	});
}

function edit_post_cancel(type, id, number, comment, multiple_truncate) {	
	var main = $('#centreColumn');
	var textarea = main.find('.comment .post-content textarea');
	
	if (textarea.length != 0) {
		var parent = $(textarea[0]).parent();
		var original_html = parent.find('.original-html-content').html();
		var original = parent.find('.original-content').text();
		var id_1 = parent.find('.original-content').data('id');
		var type_1 = parent.find('.original-content').data('type');
		var number_1 = parent.find('.original-content').data('number');
		var text = textarea.val();
		
		if (text == original) {
			show_the_more_arrow(type_1, number_1, comment);
			edit_post_update(parent, id_1, comment, multiple_truncate);
			return true;
		} else {
		  $.confirm({
		    content: unsaved_progress_text,
		    confirm: function() {
          show_the_more_arrow(type_1, number_1, comment);
          edit_post_update(parent, id_1, comment, multiple_truncate);
          return true;
		    },
		    cancel: function() {
		      return false;
		    }
		  });
		}
	}
	
	return true;
}

function edit_post_update(parent, id, comment, multiple_truncate) {
	var data = {posting: id};
	
	if (comment) {
		data.comment = true;
	}
	
	data.truncate = true;
	
	$.ajax({
		type: 'POST',
		url: '/' + feed_controller + '/get_post_updated_content' + add_feed_id(),
		data: data,
		dataType: 'html',
		success: function(ajax_one) {
			var number = parent.find('.original-content').data('number');
			var type = parent.find('.original-content').data('type');
			var el = parent;
			
			parent.hide();
			parent.html('');
			parent.append(ajax_one);
			parent.fadeIn();
			
			if (multiple_truncate) {
				delete data.truncate;
				
				if (comment) {
					var selector = el.parents('#' + type + number).find('#remaining_comment_' + number + ' .post-content');
				} else {
					var selector = el.parents('#' + type + number).find('#remaining_post_' + number + ' .post-content');
				}
				
				$.ajax({
					type: 'POST',
					url: '/' + feed_controller + '/get_post_updated_content' + add_feed_id(),
					data: data,
					dataType: 'html',
					async: false,
					success: function(ajax_two) {
						selector.hide();
						selector.html('');
						selector.append(ajax_two);
						selector.fadeIn();
					}
				});
			}
		}
	});
}

function check_for_long(type, number, comment) {
	var post = $('#' + type + number);
	
	if (comment) {
		if (post.find('div[id^="remaining_comment_"]').length > 0) {
			return true;
		}
	} else {
		if (post.find('div[id^="remaining_post_"]').length > 0) {
			return true;
		}
	}
	
	return false;
}

function dispay_the_correct_blocks(type, number, comment) {
	var post = $('#' + type + number);
	
	if (comment) {
		var post_block = post.find('#comment_' + number);
		var remaining_block = post_block.next('#remaining_comment_' + number);
	} else {
		var post_block = post.find('#post_' + number);
		var remaining_block = post_block.next('#remaining_post_' + number);
	}
	
	post_block.show();
	remaining_block.hide();
}

function hide_the_more_arrow(type, number, comment) {
	var post = $('#' + type + number);
	
	if (comment) {
		var post_block = post.find('#comment_' + number);
	} else {
		var post_block = post.find('#post_' + number);
	}
	
	post_block.find('div.centreIcon').hide();
}

function show_the_more_arrow(type, number, comment) {
	var post = $('#' + type + number);
	
	if (comment) {
		var post_block = post.find('#comment_' + number);
	} else {
		var post_block = post.find('#post_' + number);
	}
	
	post_block.find('div.centreIcon').show();
}
